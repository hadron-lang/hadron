name: CI

on:
  push:
    branches:
      - "main"
      - "development"
  pull_request:
    branches:
      - "main"
      - "development"

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    env:
      CC: clang-21
      CXX: clang++-21
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install LLVM/Clang 21 & Tools
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 21 all
          sudo apt-get install -y cmake ninja-build libgtest-dev llvm-21-dev libclang-21-dev

      - name: Fix LLVM 21 Header Conflict
        run: |
          echo "Removing conflicting cxxabi headers from LLVM include dir..."
          sudo rm -f /usr/lib/llvm-21/include/cxxabi.h
          sudo rm -f /usr/lib/llvm-21/include/__cxxabi_config.h

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTS=ON \
          -DENABLE_SANITIZERS=ON \
          -DLLVM_DIR=/usr/lib/llvm-21/lib/cmake/llvm

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure -j $(nproc)